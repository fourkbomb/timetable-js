<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Titled Document</title>


<script src="./json/TXC_2-NORT-1-sj2.xml-stations.json"></script>
<script src="./json/TXC_2-NORT-1-sj2.xml-vjdata.json"></script>

<script>
function numToDay(day) {
	switch(day) {
		case 0:
		return "Sunday";
		case 1:
		return "Monday";
		case 2:
		return "Tuesday";
		case 3:
		return "Wednesday";
		case 4:
		return "Thursday";
		case 5:
		return "Friday";
		case 6:
		return "Saturday";
	}
}

var stops = [];
var stopsAndPlats = [];
var times = {};
var LatestTrain;
for (j in TRIP_DATA) {
	times[TRIP_DATA[j]["leaves"]] = j;	
}
var html = "";

for (s in stations) {
	stops.push(stations[s]);	
}
stops = stops.sort()


var CURRENT_STATION;

function clockUpdate() {
	document.getElementById("clock").innerHTML = getHoursAndMinutes();
}

function onBitChange() {
	LatestTrain = null;
	CURRENT_STATION = document.getElementById("list").value;
	//document.getElementById("from").innerHTML = CURRENT_STATION;
	// HEAR THAT IE?
	//times = null;
	
	times = {};
	
	
	for (j in TRIP_DATA) {
		var min_offset = 0;
		var sec_offset = 0;
		var leaves = TRIP_DATA[j]["leaves"];
		var now = new Date();
		if (TRIP_DATA[j]["days"].indexOf(numToDay(now.getDay())) == -1) {
			continue;
		}
		var o = leaves.split(/:/);//, leaves);
		leaves = new Date();
		leaves.setHours(new Number(o[0]));
		leaves.setMinutes(new Number(o[1]));
		leaves.setSeconds(new Number(o[2]));
		var ok = false;
		var jps = TRIP_DATA[j]["jpref"]["jpatsect"];
		for (z in jps) {
			
			if (jps[z][1] == null) {
				if (jps[z].indexOf(CURRENT_STATION) != -1) {
					ok = true;
					break;
				}
				continue;
			}
			

			
			if (jps[z].indexOf(CURRENT_STATION) != -1) {
				ok = true;
				window.console.log(jps[z][0] + " == " + CURRENT_STATION + " index " + z);
				break;
			}	
			o = jps[z][1].split(/M/);//, jps[z][1]);
			min_offset += new Number(o[0]);
			if (jps[z][1].search("S")) {
				//window.console.log(o[1]);
				o[1] = o[1].replace(/S/, "");
				
				
				var sec = new Number(o[1]);
				if (sec != Number.NaN) {
					sec_offset += sec;
				}
			}
		}
		if (!ok) {
			continue;
		}
		min_offset++;
		leaves.setMinutes(leaves.getMinutes() + min_offset);
		if (LatestTrain == null) {
			LatestTrain = leaves;
		}
		else {
			if (LatestTrain.valueOf() < leaves.valueOf()) {
				LatestTrain = leaves;
			}
		}
		
		if (sec_offset != Number.NaN && sec_offset.constructor == Number && sec_offset.toString().search("N") == -1) {
			window.console.log(sec_offset + " != NaN");
			leaves.setSeconds(leaves.getSeconds() + sec_offset);
			//window.console.log("Skipping seconds.");
		}
		else {
			window.console.log("secs skipped!");
		}
		var now = new Date();
		leaves.setDate(now.getDate());
		leaves.setYear(now.getFullYear());
		leaves.setMonth(now.getMonth());
		var left = getHoursAndMinutesWithDate(leaves);
		window.console.log(left + " " + leaves + " (mo: " + min_offset + " so: " + sec_offset + ")");
		/*if (getHoursAndMinutesWithDate(leaves).search("NaN") != -1) {
			alert("BEGIN DEBUG...");
			var onemin = new Date();
			onemin.setMinutes(onemin.getSeconds() + 10);
			while ((new Date()).valueOf() < onemin.valueOf()) {}	
		}*/
		times[left] = j;
	}
	updateTimeLeft();
}
//times.sort();
function getHoursAndMinutes() {
	var NOW = new Date();
	return getHoursAndMinutesWithDate(NOW);

}
function getHoursAndMinutesWithDate(NOW) {
	var withsecs;
	if (withsecs == null)
		withsecs = true;
	var hours = NOW.getHours().toString();
	if (hours.length == 1) {
		hours = "0" + hours;
	}
	var minutes = NOW.getMinutes().toString();
	if (minutes.length == 1) {
		minutes = "0" + minutes;
	}
	var seconds = NOW.getSeconds().toString();
	if (seconds.length == 1 && withsecs != false) {
		seconds = "0" + seconds;
	}
	return hours + ":" + minutes + ":" + seconds;
}
var current_entry = null;
function loaded() {
	for (s in stops) {
		html += "<option value=\"" + stops[s] + "\">" + stops[s] + "</option>\n";	
	}
	clockUpdate();
	document.getElementById("list").innerHTML = html;
	onBitChange();
	updateTimeLeft();
	setInterval(updateTimeLeft, 6000);
	setInterval(clockUpdate, 1000);
}
function updateTimeLeft() {
	var NOW = new Date();
	var test = new Date();
	var first = false;
	if (NOW.valueOf() > LatestTrain.valueOf()) {
		first = true;
	}
	//LatestTrain = null;
	var best_shot;
	for (i in times) {
		var hms = i.split(":");
		if (i.search("NaN") != -1) {
			hms = TRIP_DATA[times[i]]["leaves"].split(":");	
		}
		test.setHours(new Number(hms[0]));
		test.setMinutes(new Number(hms[1]));
		
		if (!first) {
			if (TRIP_DATA[times[i]]["days"].indexOf(numToDay(NOW.getDay())) == -1) {
				continue;
			}
			if (test.valueOf() < NOW.valueOf()) {
				continue;	
			}
		}
		else {
			var newDay = NOW.getDay() + 1;
			if (newDay == 7) {
				newDay = 0;
			}
			if (TRIP_DATA[times[i]]["days"].indexOf(numToDay(newDay)) == -1) {
				continue;
			}
		}
		if (best_shot == null) {
			best_shot = [times[i], new Date(test.valueOf())];
		}
		else {
			var time2 = best_shot[1];
			if (time2.valueOf() < test.valueOf()) {
				continue;
			}
			else {
				best_shot = [times[i], new Date(test.valueOf())];
				continue;
			}
		}
		
	}
	if (best_shot == null) {
		var now = new Date();
		now.setDate(now.getDate() + 1);
		best_shot = [times[getHoursAndMinutesWithDate(LatestTrain)], LatestTrain];
		if (TRIP_DATA[best_shot[0]]["days"].indexOf(numToDay(now.getDay())) == -1) {
			best_shot = null;
		}
	}
	if (best_shot == null) {
		// STILL!
		document.getElementById("stops").innerHTML = "(no trains stopping here in the next twenty-four hours)";
		document.getElementById("time-left").innerHTML = "a long time";
		return;
	}
	
	var next = TRIP_DATA[best_shot[0]];
	var time_left = best_shot[1].valueOf() - NOW.valueOf();
	time_left /= 1000;
	time_left /= 60;
	if (time_left < 0) {
		time_left /= 60;
		time_left += 24;
		time_left *= 60;
	}
	time_left = Math.round(time_left);
	var time = new Date(best_shot[1].valueOf());
	time.setSeconds(0);
	/*
	      "jpref" : {
         "direction" : "outbound",
         "jpatsect" : [
            [
               "Revesby (Platform 2)",
               "4M"
            ],
	*/
	var text = time_left + " minutes";
	if (time_left == 1) {
		text = time_left + " minute";
	}
	else if (time_left >= 120) {
		text = Math.floor(time_left / 60) + " hours " + time_left % 60 + " minutes";
	}
	document.getElementById("time-left").innerHTML = text;
	//document.getElementById("stationlist").innerHTML = next["jpref"]["jpatsect"][0][0];
	var txt = "<table>";
	var stops = next["jpref"]["jpatsect"];
	var MinDiff = 0;
	var SecDiff = 0;
	var found_current_station = false;
//	window.console.log(" ");
//	window.console.log(" ");
	for (i = 0; i < stops.length; i++) {
		//window.console.log(stops[i][0]);
		//window.console.log(stops[i]);
		var nt = false;
		if (stops[i][0] == CURRENT_STATION) {
			//window.console.log(stops[i][0] + "==" + CURRENT_STATION);
			nt = true;
			found_current_station = true;
		}
		else if (!found_current_station) {
			//window.console.log(stops[i][0] + "!=" + CURRENT_STATION);
			continue;
		}
		else {
			//window.console.log(stops[i][0] + " after " + CURRENT_STATION);
		}
		var z = stops[i][1].split(" ");
		var minsec = z[0].split("M");
		if (!nt) {
			if (minsec.length == 2 && minsec[1].search(/S/) >= 0) {
				
				minsec[1] = minsec[1].replace(/S/, "");
				SecDiff += new Number(minsec[1]);
					
			}
			if ((SecDiff / 60) >= 1) {
				MinDiff += Math.floor(SecDiff / 60);
				SecDiff = SecDiff % 60;
			}
			MinDiff += new Number(minsec[0]);
		}
		if (z[1] == "pass") {
			
			continue;
		}
		txt += "<tr>";
		if (i != 0) {
			time.setMinutes(time.getMinutes() + MinDiff);
			time.setSeconds(time.getSeconds() + SecDiff);
			var text = "";
			var ary = stops[i][0].split("(");
			txt += "<td><strong>" + ary[0] + "&nbsp;&nbsp;</strong></td>";
			txt += "<td>(" + ary[1] + "&nbsp;&nbsp;</td>";
			//text = ary[0] + ary[1];
			txt += "<td>(<strong>" + getHoursAndMinutesWithDate(time) + "</strong>)</td></tr>";
		}
		else {
			txt += "<td>" + stops[i][0] + "</td></tr>";
		}
		MinDiff = 0;
		SecDiff = 0;
	}
	if (found_current_station == false) {
		txt = "(something screwed up)";
	}
	else {
		txt += "</table>";
	}
	document.getElementById("stops").innerHTML = txt;
	
}
</script>

<style>
body {
	background-color: white;
	color: black;
	font-family: cantarell;
}

#floating {
	padding-top: 20px;
	position:fixed;
	background-color: white;
}

#header {
	position:fixed;
	top:0;
	text-align: right;
	background-color: white;
	padding-bottom: 5px;
	height: 30px;
	font-size: 26px;
}

#clock {
	padding-right: 4em;
}

#list {
	font-family: cantarell;
	padding-bottom: 0px;
	font-size: 16px;
	border: 1;
	padding-left: 5px;
}

#stopping {
	padding-top: 80px
}

#invis {
	color: rgba(0,0,0,0);
	font-size: 0px;
}

#invis::selection {
	background-color: white;
}

</style>
</head>

<body onload="loaded()">
<div id="floating" style="font-size: 18px"><table style="border: 0; width: 100%; font-size: 26px;"><tr><td style="width: 100%">
Next train from <select style="width: 11em" id="list" onchange="onBitChange()"><option value="">Something bad happened.</option></select> is due in <span id="time-left"></span></td></tr></table>
</div>

<div id="stopping">
<b>Stopping at:</b><br />
<div id="stops">
</div>
</div>
<!-- This should technically be at the top -->
<div id="header"><table style="border: 0; width: 100%;"><tr>
<td>Time now:</td>
<td id="clock"></td>
<!--<td id="invis"><span id="from">--></span></div></td>
</tr>
</body>
</html>
